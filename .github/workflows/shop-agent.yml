name: shop-agent

on:
  push:
    paths:
      - ".github/workflows/shop-agent.yml"
      - "backend/shop-agent/**"
  pull_request:
    paths:
      - ".github/workflows/shop-agent.yml"
      - "backend/shop-agent/**"

jobs:
  shop-agent-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.14
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install Python quality tools
        run: python3 -m pip install --upgrade pip ruff mypy

      - name: Run Python standards check
        run: python3 infra/scripts/python-standards-check.py backend/shop-agent/src backend/shop-agent/tests

      - name: Run Ruff
        run: ruff check backend/shop-agent/src backend/shop-agent/tests infra/scripts/python-standards-check.py

      - name: Run mypy
        run: mypy --python-version 3.14 backend/shop-agent/src/server.py

      - name: Validate Python syntax
        run: python3 -m py_compile backend/shop-agent/src/server.py

      - name: Run unit tests
        run: python3 -m unittest discover -s backend/shop-agent/tests -p "test_*.py"

      - name: Build shop-agent image
        run: docker build -t shop-agent:test backend/shop-agent

      - name: Start shop-agent container
        run: |
          docker run -d --rm \
            --name shop-agent-test \
            -p 8091:8080 \
            -e STORE_ID=shop-001 \
            -e SHOP_AGENT_VERSION=0.1.0 \
            -e DEPLOYMENT_VERSION=ci \
            -e AGENT_AUTH_MODE=jwt \
            -e AGENT_JWT_SECRET=ci-secret \
            -e AGENT_JWT_ISSUER=control-plane \
            -e AGENT_JWT_AUDIENCE=shop-agent \
            -e AGENT_JWT_LEEWAY_SECONDS=0 \
            -e AGENT_JWT_MAX_TTL_SECONDS=900 \
            shop-agent:test

      - name: Wait for health endpoint
        run: |
          for i in $(seq 1 30); do
            if curl -fsS http://localhost:8091/health >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "shop-agent did not become healthy in time"
          exit 1

      - name: Generate JWT for API checks
        run: |
          TOKEN="$(python3 - <<'PY'
          import base64
          import hashlib
          import hmac
          import json
          import time

          def b64url(raw: bytes) -> str:
              return base64.urlsafe_b64encode(raw).decode("utf-8").rstrip("=")

          now = int(time.time())
          header = {"alg": "HS256", "typ": "JWT"}
          payload = {
              "iss": "control-plane",
              "aud": "shop-agent",
              "iat": now,
              "exp": now + 120,
              "store_id": "shop-001",
              "sub": "ci",
          }
          h = b64url(json.dumps(header, separators=(",", ":")).encode("utf-8"))
          p = b64url(json.dumps(payload, separators=(",", ":")).encode("utf-8"))
          sig = hmac.new(b"ci-secret", f"{h}.{p}".encode("utf-8"), hashlib.sha256).digest()
          print(f"{h}.{p}.{b64url(sig)}")
          PY
          )"
          echo "SHOP_AGENT_JWT=${TOKEN}" >> "$GITHUB_ENV"

      - name: Validate status endpoint with auth
        run: |
          curl -fsS -H "Authorization: Bearer ${SHOP_AGENT_JWT}" http://localhost:8091/status >/dev/null

      - name: Validate smoke endpoint with auth
        run: |
          curl -fsS -X POST -H "Authorization: Bearer ${SHOP_AGENT_JWT}" http://localhost:8091/verify/smoke >/dev/null

      - name: Dump container logs on failure
        if: failure()
        run: docker logs shop-agent-test

      - name: Shutdown
        if: always()
        run: docker rm -f shop-agent-test || true
