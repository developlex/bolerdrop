services:
  magento-db:
    image: mysql:8.0
    container_name: ${STORE_ID}-magento-db
    command: ["mysqld", "--default-authentication-plugin=mysql_native_password"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MAGENTO_DB_NAME}
      MYSQL_USER: ${MAGENTO_DB_USER}
      MYSQL_PASSWORD: ${MAGENTO_DB_PASSWORD}
    volumes:
      - magento_db_data:/var/lib/mysql
    restart: unless-stopped
    networks:
      - store-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

  magento-cache:
    image: redis:7-alpine
    container_name: ${STORE_ID}-magento-cache
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    restart: unless-stopped
    networks:
      - store-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 3s
      retries: 10
      start_period: 5s

  magento-search:
    image: opensearchproject/opensearch:2.13.0
    container_name: ${STORE_ID}-magento-search
    environment:
      discovery.type: single-node
      DISABLE_SECURITY_PLUGIN: "true"
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - magento_search_data:/usr/share/opensearch/data
    restart: unless-stopped
    networks:
      - store-network
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:9200"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  magento-app:
    build:
      context: ../../infra/docker/instance/magento-app
      dockerfile: Dockerfile
    container_name: ${STORE_ID}-magento-app
    working_dir: /var/www/html
    environment:
      MAGENTO_BASE_URL: ${MAGENTO_BASE_URL}
      MAGENTO_SOURCE_MODE: ${MAGENTO_SOURCE_MODE}
      MAGENTO_PACKAGE: ${MAGENTO_PACKAGE}
      MAGENTO_VERSION: ${MAGENTO_VERSION}
      MAGENTO_REPO_PUBLIC_KEY: ${MAGENTO_REPO_PUBLIC_KEY}
      MAGENTO_REPO_PRIVATE_KEY: ${MAGENTO_REPO_PRIVATE_KEY}
      MAGENTO_GIT_REPOSITORY: ${MAGENTO_GIT_REPOSITORY}
      MAGENTO_GIT_REF: ${MAGENTO_GIT_REF}
      MAGENTO_ADMIN_USER: ${MAGENTO_ADMIN_USER}
      MAGENTO_ADMIN_PASSWORD: ${MAGENTO_ADMIN_PASSWORD}
      MAGENTO_ADMIN_EMAIL: ${MAGENTO_ADMIN_EMAIL}
      MAGENTO_ADMIN_FIRSTNAME: ${MAGENTO_ADMIN_FIRSTNAME}
      MAGENTO_ADMIN_LASTNAME: ${MAGENTO_ADMIN_LASTNAME}
      MAGENTO_DB_HOST: magento-db
      MAGENTO_DB_PORT: "3306"
      MAGENTO_DB_NAME: ${MAGENTO_DB_NAME}
      MAGENTO_DB_USER: ${MAGENTO_DB_USER}
      MAGENTO_DB_PASSWORD: ${MAGENTO_DB_PASSWORD}
      MAGENTO_CACHE_HOST: magento-cache
      MAGENTO_CACHE_PORT: "6379"
      MAGENTO_SEARCH_HOST: magento-search
      MAGENTO_SEARCH_PORT: "9200"
      MAGENTO_LANGUAGE: ${MAGENTO_LANGUAGE}
      MAGENTO_CURRENCY: ${MAGENTO_CURRENCY}
      MAGENTO_TIMEZONE: ${MAGENTO_TIMEZONE}
      MAGENTO_USE_REWRITES: ${MAGENTO_USE_REWRITES}
    volumes:
      - magento_app_data:/var/www/html
    depends_on:
      magento-db:
        condition: service_healthy
      magento-cache:
        condition: service_healthy
      magento-search:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - store-network

  magento-web:
    image: nginx:1.27-alpine
    container_name: ${STORE_ID}-magento-web
    command:
      - /bin/sh
      - -ec
      - |
        cat >/etc/nginx/conf.d/default.conf <<'EOF'
        server {
          listen 80;
          server_name _;
          root /var/www/html/pub;
          index index.php index.html;

          location = /healthz {
            add_header Content-Type text/plain;
            return 200 "ok";
          }

          location / {
            try_files $$uri $$uri/ /index.php?$$args;
          }

          location /static/ {
            rewrite ^/static/version\d*/(.*) /static/$$1 last;
            try_files $$uri $$uri/ @static_fallback;
            expires max;
            add_header Cache-Control "public";
          }

          location @static_fallback {
            rewrite ^/static/(version\d*/)?(.*) /static.php?resource=$$2 last;
          }

          location ~ \.php$ {
            include fastcgi_params;
            fastcgi_pass magento-app:9000;
            fastcgi_param SCRIPT_FILENAME $$document_root$$fastcgi_script_name;
            fastcgi_param MAGE_RUN_TYPE store;
            fastcgi_param MAGE_RUN_CODE default;
            # Magento can emit many Set-Cookie headers on auth flows.
            fastcgi_buffer_size 64k;
            fastcgi_buffers 32 32k;
            fastcgi_busy_buffers_size 128k;
            fastcgi_temp_file_write_size 128k;
            fastcgi_read_timeout 300s;
          }
        }
        EOF
        exec nginx -g 'daemon off;'
    ports:
      - "${MAGENTO_HTTP_PORT}:80"
    volumes:
      - magento_app_data:/var/www/html:ro
    depends_on:
      magento-app:
        condition: service_started
    restart: unless-stopped
    networks:
      - store-network
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1/healthz"]
      interval: 15s
      timeout: 3s
      retries: 10
      start_period: 15s

  magento-cron:
    build:
      context: ../../infra/docker/instance/magento-app
      dockerfile: Dockerfile
    container_name: ${STORE_ID}-magento-cron
    working_dir: /var/www/html
    command:
      - /bin/sh
      - -ec
      - |
        cat >/etc/crontabs/root <<'EOF'
        * * * * * su -s /bin/sh www-data -c "cd /var/www/html && php bin/magento cron:run 2>&1 | grep -v 'Ran jobs by schedule' >> /var/www/html/var/log/magento.cron.log"
        EOF
        exec crond -f -l 8
    volumes:
      - magento_app_data:/var/www/html
    depends_on:
      magento-app:
        condition: service_started
      magento-db:
        condition: service_healthy
      magento-cache:
        condition: service_healthy
      magento-search:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - store-network

  storefront:
    build:
      context: ../../frontend/storefront
      dockerfile: Dockerfile
      target: dev
    container_name: ${STORE_ID}-storefront
    environment:
      COMMERCE_GRAPHQL_URL: http://magento-web/graphql
      STOREFRONT_BASE_URL: ${STOREFRONT_BASE_URL}
      STOREFRONT_THEME: ${STOREFRONT_THEME}
      HOSTNAME: 0.0.0.0
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"
    volumes:
      - ../../frontend/storefront:/app
      - storefront_node_modules:/app/node_modules
    ports:
      - "${STOREFRONT_PORT}:3000"
    depends_on:
      magento-web:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - store-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:3000/api/health').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 15s
      timeout: 3s
      retries: 10
      start_period: 20s

  shop-agent:
    build:
      context: ../../backend/shop-agent
      dockerfile: Dockerfile
    container_name: ${STORE_ID}-shop-agent
    environment:
      STORE_ID: ${STORE_ID}
      SHOP_AGENT_VERSION: ${SHOP_AGENT_VERSION}
      DEPLOYMENT_VERSION: ${DEPLOYMENT_VERSION}
      AGENT_AUTH_MODE: jwt
      AGENT_JWT_SECRET: ${AGENT_JWT_SECRET}
      AGENT_JWT_ISSUER: ${AGENT_JWT_ISSUER}
      AGENT_JWT_AUDIENCE: ${AGENT_JWT_AUDIENCE}
      AGENT_JWT_LEEWAY_SECONDS: ${AGENT_JWT_LEEWAY_SECONDS}
      AGENT_JWT_MAX_TTL_SECONDS: ${AGENT_JWT_MAX_TTL_SECONDS}
    ports:
      - "${SHOP_AGENT_PORT}:8080"
    restart: unless-stopped
    networks:
      - store-network
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/health"]
      interval: 15s
      timeout: 3s
      retries: 10
      start_period: 10s

volumes:
  magento_app_data:
    name: ${STORE_ID}-magento-app-data
  magento_db_data:
    name: ${STORE_ID}-magento-db-data
  magento_search_data:
    name: ${STORE_ID}-magento-search-data
  storefront_node_modules:
    name: ${STORE_ID}-storefront-node-modules

networks:
  store-network:
    name: ${STORE_ID}-network
